<!-- Load Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    .anggaran-v2-container {
        font-family: Arial, sans-serif;
        font-size: 11px;
        color: #333;
        overflow-x: auto;
    }

    .chart-container {
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 25px;
        height: 300px;
        position: relative;
    }

    .anggaran-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
        min-width: 1000px;
    }

    .anggaran-table th, .anggaran-table td {
        border: 1px solid #000;
        padding: 4px 6px;
        text-align: right;
    }

    .anggaran-table th {
        background-color: #f3f4f6;
        text-align: center;
        font-weight: bold;
    }

    .header-dipa {
        background-color: #e0f2fe !important;
        color: #0369a1;
        font-size: 14px;
        text-align: center !important;
        padding: 8px !important;
    }

    .col-month { text-align: center !important; font-weight: bold; background-color: #f9fafb; width: 100px; }
    .col-jumlah { background-color: #f3f4f6; font-weight: bold; }
    .col-doc { text-align: center !important; width: 50px; }

    .btn-doc {
        color: #2563eb;
        text-decoration: none;
        font-weight: bold;
    }

    .btn-doc:hover { text-decoration: underline; }

    .loading-overlay {
        text-align: center;
        padding: 20px;
        font-style: italic;
        color: #666;
    }

    .tabs-tahun {
        display: flex;
        gap: 5px;
        margin-bottom: 15px;
        overflow-x: auto;
        padding-bottom: 5px;
    }

    .tab-item {
        padding: 6px 15px;
        background: #eee;
        border: 1px solid #ccc;
        cursor: pointer;
        border-radius: 4px 4px 0 0;
        white-space: nowrap;
        font-size: 12px;
    }

    .tab-item.active {
        background: #fff;
        border-bottom: 1px solid #fff;
        font-weight: bold;
        color: #0369a1;
    }
</style>

<div class="anggaran-v2-container">
    <div class="tabs-tahun" id="yearTabs"></div>

    <!-- Grafik Section -->
    <div class="chart-container">
        <canvas id="monthlyChart"></canvas>
    </div>

    <div id="contentAnggaran">
        <div class="loading-overlay">Memuat data anggaran...</div>
    </div>
</div>

<script>
    (function() {
        const API_URL = 'https://web-api.pa-penajam.go.id/api/anggaran';
        const MONTHS = ["", "Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Agu", "Sep", "Okt", "Nov", "Des"];
        const FULL_MONTHS = ["", "JANUARI", "FEBRUARI", "MARET", "APRIL", "MEI", "JUNI", "JULI", "AGUSTUS", "SEPTEMBER", "OKTOBER", "NOVEMBER", "DESEMBER"];
        
        const START_YEAR = 2023;
        const CURRENT_YEAR = new Date().getFullYear();
        let myChart = null;

        function initTabs() {
            const tabsContainer = document.getElementById('yearTabs');
            let tabsHtml = "";
            for (let y = CURRENT_YEAR; y >= START_YEAR; y--) {
                const activeClass = (y === CURRENT_YEAR) ? "active" : "";
                tabsHtml += `<div class="tab-item ${activeClass}" data-year="${y}">TAHUN ${y}</div>`;
            }
            tabsContainer.innerHTML = tabsHtml;

            document.querySelectorAll('.tab-item').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    fetchData(this.dataset.year);
                });
            });
        }
        
        async function fetchData(year) {
            document.getElementById('contentAnggaran').innerHTML = '<div class="loading-overlay">Memuat data anggaran '+year+'...</div>';
            try {
                const response = await fetch(`${API_URL}?tahun=${year}&per_page=300`);
                const result = await response.json();
                renderAll(result.data, year);
            } catch (e) {
                document.getElementById('contentAnggaran').innerHTML = "Gagal memuat data.";
            }
        }

        function renderAll(data, year) {
            updateChart(data, year);
            renderTables(data, year);
        }

        function updateChart(data, year) {
            const ctx = document.getElementById('monthlyChart').getContext('2d');
            
            // Proses data bulanan
            const dipa01Monthly = new Array(12).fill(0);
            const dipa04Monthly = new Array(12).fill(0);

            data.forEach(item => {
                if (item.bulan >= 1 && item.bulan <= 12) {
                    if (item.dipa === 'DIPA 01') dipa01Monthly[item.bulan - 1] += item.realisasi;
                    if (item.dipa === 'DIPA 04') dipa04Monthly[item.bulan - 1] += item.realisasi;
                }
            });

            if (myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: MONTHS.slice(1),
                    datasets: [
                        {
                            label: 'Realisasi DIPA 01',
                            data: dipa01Monthly,
                            backgroundColor: 'rgba(3, 105, 161, 0.7)',
                            borderColor: 'rgb(3, 105, 161)',
                            borderWidth: 1
                        },
                        {
                            label: 'Realisasi DIPA 04',
                            data: dipa04Monthly,
                            backgroundColor: 'rgba(16, 185, 129, 0.7)',
                            borderColor: 'rgb(16, 185, 129)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Tren Penyerapan Anggaran Bulanan - Tahun ' + year,
                            font: { size: 14 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    if (value >= 1000000000) return (value / 1000000000).toFixed(1) + ' M';
                                    if (value >= 1000000) return (value / 1000000).toFixed(0) + ' jt';
                                    return value;
                                }
                            }
                        }
                    }
                }
            });
        }

        function formatRp(val) {
            if (!val || val == 0) return "-";
            return "Rp " + new Intl.NumberFormat('id-ID').format(val);
        }

        function renderTables(data, year) {
            let html = "";
            const dipa01 = data.filter(d => d.dipa === 'DIPA 01');
            const dipa04 = data.filter(d => d.dipa === 'DIPA 04');

            html += generateDipaTable('DIPA 01 (BADAN URUSAN ADMINISTRASI)', 'DIPA 01', ['Belanja Pegawai', 'Belanja Barang', 'Belanja Modal'], dipa01, year);
            html += "<div style='height: 30px;'></div>";
            html += generateDipaTable('DIPA 04 (DIRJEN BADAN PERADILAN AGAMA)', 'DIPA 04', ['POSBAKUM', 'Pembebasan Biaya Perkara', 'Sidang Di Luar Gedung'], dipa04, year);

            document.getElementById('contentAnggaran').innerHTML = html;
        }

        function generateDipaTable(title, dipaCode, categories, data, year) {
            const pagus = {};
            categories.forEach(cat => {
                const item = data.find(d => d.kategori === cat && d.pagu > 0);
                pagus[cat] = item ? item.pagu : 0;
            });
            const totalPagu = Object.values(pagus).reduce((a, b) => a + b, 0);

            let tableHtml = `<table class="anggaran-table">
                <thead>
                    <tr><th colspan="8" class="header-dipa">${title}</th></tr>
                    <tr>
                        <th style="width:100px">${dipaCode}</th>
                        ${categories.map(cat => `<th>${formatRp(pagus[cat])}</th>`).join('')}
                        <th class="col-jumlah" style="width:150px">${formatRp(totalPagu)}</th>
                        <th rowspan="2" style="width:100px">Persentase Realisasi Anggaran</th>
                        <th rowspan="2" style="width:60px">Realisasi Anggaran Belanja</th>
                        <th rowspan="2" style="width:100px">Realisasi Anggaran</th>
                    </tr>
                    <tr>
                        <th>TAHUN ${year}</th>
                        ${categories.map(cat => `<th>${cat}</th>`).join('')}
                        <th class="col-jumlah">Jumlah</th>
                    </tr>
                </thead>
                <tbody>`;

            let totalPerCategory = {};
            categories.forEach(c => totalPerCategory[c] = 0);

            for (let m = 1; m <= 12; m++) {
                let monthlyData = data.filter(d => d.bulan === m);
                let rowSum = 0;
                let docLink = "";

                const entryWithDoc = monthlyData.find(d => d.link_dokumen && d.link_dokumen !== "");
                if (entryWithDoc) docLink = entryWithDoc.link_dokumen;

                tableHtml += `<tr><td class="col-month">${FULL_MONTHS[m]}</td>`;
                
                categories.forEach(cat => {
                    const entry = monthlyData.find(d => d.kategori === cat);
                    const val = entry ? entry.realisasi : 0;
                    tableHtml += `<td>${formatRp(val)}</td>`;
                    rowSum += val;
                    totalPerCategory[cat] += val;
                });

                tableHtml += `<td class="col-jumlah">${formatRp(rowSum)}</td>`;
                
                if (m === 1) tableHtml += `<td rowspan="12" style="background:#fff"></td>`;
                
                tableHtml += `<td class="col-doc">${docLink ? `<a href="${docLink}" target="_blank" class="btn-doc">doc</a>` : '-'}</td>`;

                if (m === 1) tableHtml += `<td rowspan="6" style="text-align:center; background:#f9fafb; font-weight:bold;">Semester 1</td>`;
                else if (m === 7) tableHtml += `<td rowspan="6" style="text-align:center; background:#f9fafb; font-weight:bold;">Semester 2</td>`;

                tableHtml += `</tr>`;
            }

            const grandTotal = Object.values(totalPerCategory).reduce((a, b) => a + b, 0);
            const totalPercentage = totalPagu > 0 ? (grandTotal / totalPagu * 100).toFixed(2) : 0;

            tableHtml += `<tr style="background:#f3f4f6; font-weight:bold;">
                <td class="col-month">JUMLAH</td>
                ${categories.map(cat => `<td>${formatRp(totalPerCategory[cat])}</td>`).join('')}
                <td class="col-jumlah">${formatRp(grandTotal)}</td>
                <td style="text-align:center; font-size:14px; color:#059669;">${totalPercentage}%</td>
                <td></td><td></td>
            </tr>`;

            tableHtml += `<tr style="background:#fff; font-weight:bold;">
                <td class="col-month">SISA</td>
                ${categories.map(cat => `<td>${formatRp(pagus[cat] - totalPerCategory[cat])}</td>`).join('')}
                <td class="col-jumlah">${formatRp(totalPagu - grandTotal)}</td>
                <td style="text-align:center; font-size:14px; color:#dc2626;">${(100 - totalPercentage).toFixed(2)}%</td>
                <td></td><td></td>
            </tr>`;

            tableHtml += `</tbody></table>`;
            return tableHtml;
        }

        initTabs();
        fetchData(CURRENT_YEAR);
    })();
</script>